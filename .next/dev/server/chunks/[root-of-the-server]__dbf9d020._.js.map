{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/percyscastillo/Desktop/proyectos%20coding/agro-erp-production-2/src/lib/supabase/server.js"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Creates a Supabase client for use in API routes and Server Components.\n * Uses the user's session via cookies for RLS.\n * \n * Usage: In API routes (app/api/...) and Server Components\n * Example: const supabase = await createServerSupabaseClient();\n * \n * IMPORTANT: This function is async in Next.js 16+ because cookies() is async.\n */\nexport async function createServerSupabaseClient() {\n  const cookieStore = await cookies();\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            );\n          } catch {\n            // Called from Server Component - can be ignored if middleware refreshes sessions\n          }\n        },\n      },\n    }\n  );\n}\n\n/**\n * Service Role client - bypasses RLS.\n * ONLY use in trusted server-side code (API routes) for admin operations.\n * \n * WARNING: This client has full database access. Never expose to client.\n */\nexport const supabaseAdmin = createSupabaseClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_ROLE_KEY,\n  {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  }\n);\n\n// Aliases for backwards compatibility\nexport const createClient = createServerSupabaseClient;\nexport const supabase = supabaseAdmin;"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AACA;AACA;;;;AAWO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,8MAAO;IAEjC,OAAO,IAAA,mQAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,iFAAiF;gBACnF;YACF;QACF;IACF;AAEJ;AAQO,MAAM,gBAAgB,IAAA,2QAAoB,gFAE/C,QAAQ,GAAG,CAAC,yBAAyB,EACrC;IACE,MAAM;QACJ,kBAAkB;QAClB,gBAAgB;IAClB;AACF;AAIK,MAAM,eAAe;AACrB,MAAM,WAAW"}},
    {"offset": {"line": 86, "column": 0}, "map": {"version":3,"sources":["file:///Users/percyscastillo/Desktop/proyectos%20coding/agro-erp-production-2/app/api/sales/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { createServerSupabaseClient } from \"@/src/lib/supabase/server\";\n\nexport async function GET(req) {\n  try {\n    const supabase = await createServerSupabaseClient();\n    const orgSlug = req.headers.get(\"x-org-slug\");\n\n    if (!orgSlug) {\n      return NextResponse.json({ error: \"Missing org slug\" }, { status: 400 });\n    }\n\n    const { data: org } = await supabase\n      .from(\"organizations\")\n      .select(\"id\")\n      .eq(\"slug\", orgSlug)\n      .single();\n\n    if (!org) {\n      return NextResponse.json({ error: \"Organization not found\" }, { status: 404 });\n    }\n\n    const orgId = org.id;\n\n    const { searchParams } = new URL(req.url);\n    const startDate = searchParams.get(\"startDate\");\n    const endDate = searchParams.get(\"endDate\");\n    const limit = Number(searchParams.get(\"limit\") || 100);\n    const offset = Number(searchParams.get(\"offset\") || 0);\n\n    let query = supabase\n      .from(\"sales\")\n      .select(`\n        id,\n        org_id,\n        branch_id,\n        factura,\n        fecha,\n        client_id,\n        user_id,\n        subtotal,\n        descuento,\n        iva,\n        total,\n        margen,\n        potential_sale,\n        created_at,\n        clients (\n          id,\n          first_name,\n          last_name,\n          phone,\n          address,\n          city\n        ),\n        sales_items (\n          id,\n          product_id,\n          quantity,\n          price,\n          subtotal,\n          cost,\n          margin,\n          products (id, name, sku, category)\n        )\n      `)\n      .eq(\"org_id\", orgId)\n      .order(\"created_at\", { ascending: false })\n      .range(offset, offset + limit - 1);\n\n    if (startDate) query = query.gte(\"fecha\", startDate);\n    if (endDate) query = query.lte(\"fecha\", endDate);\n\n    const { data: sales, error } = await query;\n\n    if (error) throw error;\n\n    const totals = (sales || []).reduce((acc, sale) => {\n      acc.totalRevenue += Number(sale.total) || 0;\n      acc.totalMargin += Number(sale.margen) || 0;\n      acc.totalItems += (sale.sales_items || []).reduce((sum, item) => sum + Number(item.quantity || 0), 0);\n      acc.totalCost += (sale.sales_items || []).reduce((sum, item) => sum + (Number(item.cost || 0) * Number(item.quantity || 0)), 0);\n      return acc;\n    }, { totalRevenue: 0, totalItems: 0, totalMargin: 0, totalCost: 0 });\n\n    return NextResponse.json({\n      success: true,\n      sales: sales || [],\n      count: sales?.length || 0,\n      totals,\n    });\n  } catch (error) {\n    console.error(\"Sales API error:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n\nexport async function PUT(req) {\n  try {\n    const supabase = await createServerSupabaseClient();\n    const orgSlug = req.headers.get(\"x-org-slug\");\n\n    if (!orgSlug) {\n      return NextResponse.json({ error: \"Missing org slug\" }, { status: 400 });\n    }\n\n    const { data: org } = await supabase\n      .from(\"organizations\")\n      .select(\"id\")\n      .eq(\"slug\", orgSlug)\n      .single();\n\n    if (!org) {\n      return NextResponse.json({ error: \"Organization not found\" }, { status: 404 });\n    }\n\n    const body = await req.json();\n    const { id, ...updateData } = body;\n\n    const { data, error } = await supabase\n      .from(\"sales\")\n      .update(updateData)\n      .eq(\"id\", id)\n      .eq(\"org_id\", org.id)\n      .select()\n      .single();\n\n    if (error) throw error;\n\n    return NextResponse.json({ success: true, sale: data });\n  } catch (error) {\n    console.error(\"Sales update error:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n\nexport async function DELETE(req) {\n  try {\n    const supabase = await createServerSupabaseClient();\n    const orgSlug = req.headers.get(\"x-org-slug\");\n\n    if (!orgSlug) {\n      return NextResponse.json({ error: \"Missing org slug\" }, { status: 400 });\n    }\n\n    const { data: org } = await supabase\n      .from(\"organizations\")\n      .select(\"id\")\n      .eq(\"slug\", orgSlug)\n      .single();\n\n    if (!org) {\n      return NextResponse.json({ error: \"Organization not found\" }, { status: 404 });\n    }\n\n    const body = await req.json();\n    const { id } = body;\n\n    await supabase.from(\"sales_items\").delete().eq(\"sale_id\", id);\n    const { error } = await supabase.from(\"sales\").delete().eq(\"id\", id).eq(\"org_id\", org.id);\n\n    if (error) throw error;\n\n    return NextResponse.json({ success: true, message: \"Venta eliminada\" });\n  } catch (error) {\n    console.error(\"Sales delete error:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}