{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/percyscastillo/Desktop/proyectos%20coding/agro-erp-production-2/src/lib/supabase/server.js"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\";\n\n/**\n * Creates a Supabase client for use in API routes and Server Components.\n * Uses the user's session via cookies for RLS.\n * \n * Usage: In API routes (app/api/...) and Server Components\n * Example: const supabase = await createServerSupabaseClient();\n * \n * IMPORTANT: This function is async in Next.js 16+ because cookies() is async.\n */\nexport async function createServerSupabaseClient() {\n  const cookieStore = await cookies();\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            );\n          } catch {\n            // Called from Server Component - can be ignored if middleware refreshes sessions\n          }\n        },\n      },\n    }\n  );\n}\n\n/**\n * Service Role client - bypasses RLS.\n * ONLY use in trusted server-side code (API routes) for admin operations.\n * \n * WARNING: This client has full database access. Never expose to client.\n */\nexport const supabaseAdmin = createSupabaseClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL,\n  process.env.SUPABASE_SERVICE_ROLE_KEY,\n  {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  }\n);\n\n// Aliases for backwards compatibility\nexport const createClient = createServerSupabaseClient;\nexport const supabase = supabaseAdmin;"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AACA;AACA;;;;AAWO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,8MAAO;IAEjC,OAAO,IAAA,mQAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,iFAAiF;gBACnF;YACF;QACF;IACF;AAEJ;AAQO,MAAM,gBAAgB,IAAA,2QAAoB,gFAE/C,QAAQ,GAAG,CAAC,yBAAyB,EACrC;IACE,MAAM;QACJ,kBAAkB;QAClB,gBAAgB;IAClB;AACF;AAIK,MAAM,eAAe;AACrB,MAAM,WAAW"}},
    {"offset": {"line": 86, "column": 0}, "map": {"version":3,"sources":["file:///Users/percyscastillo/Desktop/proyectos%20coding/agro-erp-production-2/app/api/crm/opportunities/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { createServerSupabaseClient } from \"@/src/lib/supabase/server\";\n\n/* ===========================================================\n   GET - LISTAR OPORTUNIDADES\n   =========================================================== */\nexport async function GET(req) {\n  try {\n    const supabase = await createServerSupabaseClient();\n    const orgSlug = req.headers.get(\"x-org-slug\");\n\n    if (!orgSlug)\n      return NextResponse.json({ error: \"Missing org slug\" }, { status: 400 });\n\n    const { data: org } = await supabase\n      .from(\"organizations\")\n      .select(\"id\")\n      .eq(\"slug\", orgSlug)\n      .single();\n\n    const { data, error } = await supabase\n      .from(\"crm_opportunities\")\n      .select(`\n        *,\n        client:clients(id, first_name, last_name, phone),\n        stage:crm_stages(id, name, code, color, probability, sort_order)\n      `)\n      .eq(\"org_id\", org.id)\n      .order(\"created_at\", { ascending: false });\n\n    if (error) throw error;\n\n    const formatted = data.map((opp) => ({\n      ...opp,\n      client_id: opp.client?.id || null,\n      client_name: `${opp.client?.first_name || \"\"} ${opp.client?.last_name || \"\"}`.trim(),\n      client_phone: opp.client?.phone || null,\n\n      stage_id: opp.stage?.id ?? opp.stage_id, // FIX\n      stage_name: opp.stage?.name || null,\n      stage_color: opp.stage?.color || \"gray\",\n      stage_order: opp.stage?.sort_order || 0,\n      stage_code: opp.stage?.code || null,\n    }));\n\n    return NextResponse.json({ opportunities: formatted });\n\n  } catch (err) {\n    return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}\n\n/* ===========================================================\n   POST - CREAR OPORTUNIDAD\n   =========================================================== */\nexport async function POST(req) {\n  try {\n    const supabase = await createServerSupabaseClient();\n    const orgSlug = req.headers.get(\"x-org-slug\");\n    const body = await req.json();\n\n    if (!orgSlug)\n      return NextResponse.json({ error: \"Missing org slug\" }, { status: 400 });\n\n    const { data: org } = await supabase\n      .from(\"organizations\")\n      .select(\"id\")\n      .eq(\"slug\", orgSlug)\n      .single();\n\n    // Obtener primera etapa autom√°ticamente\n    const { data: defaultStage } = await supabase\n      .from(\"crm_stages\")\n      .select(\"id\")\n      .order(\"sort_order\")\n      .limit(1)\n      .single();\n\n    const stageToUse = body.stage_id || defaultStage.id;\n\n    const insertData = {\n      org_id: org.id,\n      title: body.title,\n      client_id: body.client_id || null,\n      amount: body.amount || 0,\n      stage_id: stageToUse,\n      status: body.status || \"open\",\n      expected_close_date: body.expected_close_date || null,\n      source: body.source || null,\n      notes: body.notes || null,\n    };\n\n    const { data, error } = await supabase\n      .from(\"crm_opportunities\")\n      .insert(insertData)\n      .select(`\n        *,\n        client:clients(id, first_name, last_name, phone),\n        stage:crm_stages(id, name, code, color, probability, sort_order)\n      `)\n      .single();\n\n    if (error) throw error;\n\n    const formatted = {\n      ...data,\n      client_id: data.client?.id || null,\n      client_name: `${data.client?.first_name || \"\"} ${data.client?.last_name || \"\"}`.trim(),\n\n      stage_id: data.stage?.id,\n      stage_name: data.stage?.name,\n      stage_color: data.stage?.color,\n      stage_order: data.stage?.sort_order,\n      stage_code: data.stage?.code,\n    };\n\n    return NextResponse.json({ opportunity: formatted });\n\n  } catch (err) {\n    return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}\n\n/* ===========================================================\n   PUT - ACTUALIZAR OPORTUNIDAD\n   =========================================================== */\nexport async function PUT(req) {\n  try {\n    const supabase = await createServerSupabaseClient();\n    const body = await req.json();\n    const orgSlug = req.headers.get(\"x-org-slug\");\n\n    if (!orgSlug || !body.id)\n      return NextResponse.json({ error: \"Missing data\" }, { status: 400 });\n\n    const { data: org } = await supabase\n      .from(\"organizations\")\n      .select(\"id\")\n      .eq(\"slug\", orgSlug)\n      .single();\n\n    const updateData = {\n      title: body.title,\n      client_id: body.client_id || null,\n      amount: body.amount,\n      stage_id: body.stage_id,\n      status: body.status,\n      expected_close_date: body.expected_close_date,\n      source: body.source,\n      notes: body.notes,\n      lost_reason: body.lost_reason || null,\n      updated_at: new Date().toISOString(),\n    };\n\n    const { data, error } = await supabase\n      .from(\"crm_opportunities\")\n      .update(updateData)\n      .eq(\"id\", body.id)\n      .eq(\"org_id\", org.id)\n      .select(`\n        *,\n        client:clients(id, first_name, last_name, phone),\n        stage:crm_stages(id, name, code, color, probability, sort_order)\n      `)\n      .single();\n\n    if (error) throw error;\n\n    const formatted = {\n      ...data,\n      client_id: data.client?.id || null,\n      client_name: `${data.client?.first_name || \"\"} ${data.client?.last_name || \"\"}`.trim(),\n\n      stage_id: data.stage?.id,\n      stage_name: data.stage?.name,\n      stage_color: data.stage?.color,\n      stage_order: data.stage?.sort_order,\n      stage_code: data.stage?.code,\n    };\n\n    return NextResponse.json({ opportunity: formatted });\n\n  } catch (err) {\n    return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}\n\n/* ===========================================================\n   DELETE\n   =========================================================== */\nexport async function DELETE(req) {\n  try {\n    const supabase = await createServerSupabaseClient();\n    const orgSlug = req.headers.get(\"x-org-slug\");\n\n    const { searchParams } = new URL(req.url);\n    const id = searchParams.get(\"id\");\n\n    if (!orgSlug || !id)\n      return NextResponse.json({ error: \"Missing data\" }, { status: 400 });\n\n    const { data: org } = await supabase\n      .from(\"organizations\")\n      .select(\"id\")\n      .eq(\"slug\", orgSlug)\n      .single();\n\n    const { error } = await supabase\n      .from(\"crm_opportunities\")\n      .delete()\n      .eq(\"id\", id)\n      .eq(\"org_id\", org.id);\n\n    if (error) throw error;\n\n    return NextResponse.json({ success: true });\n\n  } catch (err) {\n    return NextResponse.json({ error: err.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}